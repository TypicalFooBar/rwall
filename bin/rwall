#!/bin/bash

# Get the rwall root directory
rwall_root_directory="$( dirname $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd ))"

# Navigate to the rwall root directory
cd $rwall_root_directory

# Create the tmp directory if it doesn't already exist
mkdir -p tmp

# Remove all files in the rwall/tmp directory
rm -r tmp/*

# Read the ini file for parameters
q=$(grep q= etc/rwall.ini | cut -f2- -d '=')
res=$(grep res= etc/rwall.ini | cut -f2- -d '=')

# Download the html based on our search parameters
wget "http://alpha.wallhaven.cc/wallpaper/search?q=$q&categories=111&purity=100&resolutions=$res&sorting=random&order=asc" -O tmp/wallhaven.html

# grep the image ID
#id=$(grep -o -m 1 '<a href="javascript:;" data-id=".*" ' tmp/wallhaven.html | grep -o [0-9].*[0-9])
id=$(grep -o -m 1 'data-src=.*"' tmp/wallhaven.html | grep -o [0-9].*[0-9])

# Some variables to help us know if we found the image and what file type it is
image_found=1
file_type=""

# JPG
if [ $image_found -eq 1 ];
then
	wget_image=$(wget http://alpha.wallhaven.cc/wallpapers/full/wallhaven-$id.jpg -O tmp/wallpaper-$id.jpg)
	if [ $? -eq 0 ]
	then
		image_found=0
		file_type="jpg"
	fi
fi

# PNG
if [ $image_found -eq 1 ];
then
	wget_image=$(wget http://alpha.wallhaven.cc/wallpapers/full/wallhaven-$id.png -O tmp/wallpaper-$id.png)
	if [ $? -eq 0 ]
	then
		image_found=0
		file_type="png"
	fi
fi

# export DBUS_SESSION_BUS_ADDRESS environment variable
# Necessary for this script to run as cron job
PID=$(pgrep gnome-session)
export DBUS_SESSION_BUS_ADDRESS=$(grep -z DBUS_SESSION_BUS_ADDRESS /proc/$PID/environ|cut -d= -f2-)

# Change the wallpaper
gsettings set org.gnome.desktop.background picture-uri "file://$rwall_root_directory/tmp/wallpaper-$id.$file_type"
