#!/bin/bash

# Get the rwall root directory
rwall_root_directory="$( dirname $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd ))"

# This is the line that will be place in or removed from the crontab
cronEntry="0,30 * * * * DISPLAY=:0.0 $rwall_root_directory/bin/rwall"

# Toggles the rwall cron job in crontab
if [[ $1 == "toggle-cron" ]];
then
    # Check if rwall is already installed in crontab
    crontabGrepRwall="$(crontab -l | grep 'rwall')"
    
    # If the string is empty, then rwall is not in crontab
    if [[ $crontabGrepRwall == "" ]];
    then
        (crontab -l; echo "$cronEntry") | crontab -
    else
        # Add the cron entry, but first change the cron entry string to replace all '*' with '\*' for sed to work
        crontab -l | sed "\|${cronEntry//[*]/\\*}|d" | crontab -
    fi
    
    exit
fi

# Navigate to the rwall root directory
cd $rwall_root_directory

# Create the tmp directory if it doesn't already exist
mkdir -p tmp

# Remove all files in the rwall/tmp directory
rm -r tmp/*

# Read the ini file for parameters
q=$(grep q= etc/rwall.ini | cut -f2- -d '=')
res=$(grep res= etc/rwall.ini | cut -f2- -d '=')

# Download the html based on our search parameters
wget "http://alpha.wallhaven.cc/search?q=$q&categories=111&purity=100&resolutions=$res&sorting=random&order=asc" -O tmp/wallhaven.html

# grep the image ID
#id=$(grep -o -m 1 '<a href="javascript:;" data-id=".*" ' tmp/wallhaven.html | grep -o [0-9].*[0-9])
id=$(grep -oP 'wallpaper-id="\K[^"]*' tmp/wallhaven.html | head -1)

# Some variables to help us know if we found the image and what file type it is
image_found=1
file_type=""

# JPG
if [ $image_found -eq 1 ];
then
	wget_image=$(wget http://alpha.wallhaven.cc/wallpapers/full/wallhaven-$id.jpg -O tmp/wallpaper-$id.jpg)
	if [ $? -eq 0 ]
	then
		image_found=0
		file_type="jpg"
	fi
fi

# PNG
if [ $image_found -eq 1 ];
then
	wget_image=$(wget http://alpha.wallhaven.cc/wallpapers/full/wallhaven-$id.png -O tmp/wallpaper-$id.png)
	if [ $? -eq 0 ]
	then
		image_found=0
		file_type="png"
	fi
fi

# Change the wallpaper
gsettings set org.gnome.desktop.background picture-uri "file://$rwall_root_directory/tmp/wallpaper-$id.$file_type"
